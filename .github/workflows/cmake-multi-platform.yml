name: build-imagec

on:
  push:
    branches:
      - main
      - random_forest
    tags:
      - '*'
  pull_request:
    branches:
      - main

#concurrency:
#  group: ${{ github.workflow }}-${{ github.ref }}
#  cancel-in-progress: true


jobs:
  
  #
  # Linux
  #
  build-linux:
    name: Build on Linux (${{ matrix.with-cuda == 'True' && 'With CUDA' || 'CPU Only' }})
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        with-cuda: ["True", "False"]
    container:
      image: joda001/imagec-dev:linux-latest
      credentials:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build
        run: |
          chmod +x ./build_linux.sh
          ./build_linux.sh "${{ github.ref_name }}" "${{ secrets.CONAN_IMAGEC_ARTIFACTORY_PW }}" ${{ matrix.with-cuda }} "${{ github.workspace }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: imagec-x64-linux-${{ matrix.with-cuda == 'True' && 'cuda' || 'cpu' }}
          include-hidden-files: true
          if-no-files-found: error
          path: build/build/output

  #
  # Windows
  #
  build-windows:
    name: Build on Windows (${{ matrix.with-cuda == 'True' && 'With CUDA' || 'CPU Only' }})
    runs-on: windows-2022
    strategy:
      matrix:
        with-cuda: ["True", "False"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4


      - name: Build
        run: ./build_win.ps1 "${{ github.ref_name }}" "${{ secrets.CONAN_IMAGEC_ARTIFACTORY_PW }}" ${{ matrix.with-cuda }} "${{ github.workspace }}"
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: imagec-x64-win-${{ matrix.with-cuda == 'True' && 'cuda' || 'cpu' }}
          include-hidden-files: true
          if-no-files-found: error
          path: build/build/output

  #
  # MacOS
  #
  build-macos:
    name: Build on MacOs (CPU Only)
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build
        run: |
          chmod +x ./build_macos.sh
          ./build_macos.sh "${{ github.ref_name }}" "${{ secrets.CONAN_IMAGEC_ARTIFACTORY_PW }}" ${{ matrix.with-cuda }} "${{ github.workspace }}"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: imagec-arm64-macos-cpu
          include-hidden-files: true
          if-no-files-found: error
          path: build/build/output

  #
  # Deploy
  #
  deploy:
    needs:
      - build-windows
      - build-linux
      - build-macos
    runs-on: ubuntu-latest
    steps:

      - uses: actions/download-artifact@v4
        with:
          include-hidden-files: true
          name: imagec-x64-linux
          path: imagec-x64-linux

      - uses: actions/download-artifact@v4
        with:
          include-hidden-files: true
          name: imagec-arm64-macos
          path: imagec-arm64-macos

      - uses: actions/download-artifact@v4
        with:
          include-hidden-files: true
          name: imagec-x64-win
          path: imagec-x64-win

      - name: Rename files through architecture
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          chmod +x imagec-x64-linux/imagec
          chmod +x imagec-x64-linux/imagec.sh
          chmod +x imagec-arm64-macos/imagec.app/Contents/MacOS/imagec

          zip -r imagec-x64-linux-bundle.zip imagec-x64-linux
          zip -r imagec-x64-win-bundle.zip imagec-x64-win
          zip -r imagec-arm64-macos-bundle.zip imagec-arm64-macos
          
          
          timestamp=$(date +"%Y-%m-%d %H:%M:%S")
          hash_value_linux=$(sha256sum imagec-x64-linux/imagec | cut -d ' ' -f 1)
          hash_value_win=$(sha256sum imagec-x64-win/imagec.exe | cut -d ' ' -f 1)
          hash_value_macos=$(sha256sum imagec-arm64-macos/imagec.app/Contents/MacOS/imagec | cut -d ' ' -f 1)
          version="${GITHUB_REF#refs/tags/}"
          
          zip -r imagec-x64-linux-bin.zip imagec-x64-linux/imagec
          zip -r imagec-x64-win-bin.zip imagec-x64-win/imagec.exe
          zip -r imagec-arm64-macos-bin.zip imagec-arm64-macos/imagec.app

          json_string_linux=$(cat <<-EOF
          {
            "version": "$version",
            "sha256": "$hash_value_linux",
            "timestamp": "$timestamp"
          }
          EOF
          )
          
          json_string_win=$(cat <<-EOF
          {
            "version": "$version",
            "sha256": "$hash_value_win",
            "timestamp": "$timestamp"
          }
          EOF
          )

          json_string_macos=$(cat <<-EOF
          {
            "version": "$version",
            "sha256": "$hash_value_macos",
            "timestamp": "$timestamp"
          }
          EOF
          )

          echo "$json_string_linux"
          echo "$json_string_win"
          echo "$json_string_macos"

          echo "$json_string_linux" > imagec-x64-linux-bundle.json
          echo "$json_string_win" > imagec-x64-win-bundle.json
          echo "$json_string_macos" > imagec-arm64-macos-bundle.json

      - name: Upload Additional Files
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          files: |
            imagec-x64-linux-bundle.zip
            imagec-x64-win-bundle.zip
            imagec-arm64-macos-bundle.zip
            imagec-x64-linux-bin.zip
            imagec-x64-win-bin.zip
            imagec-arm64-macos-bin.zip
      
      - name: Upload to imagec.org
        if: startsWith(github.ref, 'refs/tags/') && !contains(github.ref, 'alpha')
        env:
          SSH_KEY: ${{ secrets.SSH_KEY_IMAGEC }}
          SERVER_NAME : ${{ secrets.SERVER_NAME_IMAGEC }}
        run: |
          echo "$SSH_KEY" > ssh_key_for_github
          chmod 400 ssh_key_for_github
          scp -o StrictHostKeyChecking=no -i ssh_key_for_github imagec-x64-linux-bundle.zip github@$SERVER_NAME:/var/www/html/downloads/imagec-x64-linux-bundle.zip
          scp -o StrictHostKeyChecking=no -i ssh_key_for_github imagec-x64-linux-bundle.json github@$SERVER_NAME:/var/www/html/downloads/imagec-x64-linux-bundle.json
          scp -o StrictHostKeyChecking=no -i ssh_key_for_github imagec-x64-win-bundle.zip github@$SERVER_NAME:/var/www/html/downloads/imagec-x64-win-bundle.zip
          scp -o StrictHostKeyChecking=no -i ssh_key_for_github imagec-x64-win-bundle.json github@$SERVER_NAME:/var/www/html/downloads/imagec-x64-win-bundle.json
          scp -o StrictHostKeyChecking=no -i ssh_key_for_github imagec-arm64-macos-bundle.zip github@$SERVER_NAME:/var/www/html/downloads/imagec-arm64-macos-bundle.zip
          scp -o StrictHostKeyChecking=no -i ssh_key_for_github imagec-arm64-macos-bundle.json github@$SERVER_NAME:/var/www/html/downloads/imagec-arm64-macos-bundle.json
          rm -rf ssh_key_for_github
